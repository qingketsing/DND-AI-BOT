# DND QQ BOT

本项目为使用AI作为DM的跑团QQ机器人，主要游玩方式为在群中聊天进行剧情推进。

User: 这个项目我想先写一个Alpha版本，尽可能少的进行设定，但是问题是AI的记忆有限。这个项目的实现步骤应该是怎样的

GitHub Copilot: 针对你想要的 **Alpha 版本（极简设定、解决记忆限制、DND 跑团）** 的目标，我为你设计了以下实现路线图。

核心思路是：**将“规则计算”交给代码，将“剧情描述”交给 AI，并利用“外部存储”来辅助 AI 的记忆。**

### 核心难点解决方案：如何应对 AI 记忆有限？
在 Alpha 版本中，不要指望 AI 记住所有事情。采用 **"滑动窗口 + 动态状态注入"** 的策略：

1.  **剧情记忆 (Summary + History)**:
    *   不要把几千条聊天记录全发给 AI。
    *   只保留最近 **10-20 轮对话**（短期记忆）。
    *   每隔一段时间（或当短期记忆满了），让 AI 写一段 **“剧情摘要”**，存入数据库。
    *   之后的 Prompt 结构：`[系统指令] + [剧情摘要(长期记忆)] + [最近对话(短期记忆)]`。
2.  **数据记忆 (State Injection)**:
    *   **不要** 让 AI 去记 "玩家A 还有 5 点血" 或者 "玩家B 有一把长剑"。这是 AI 最容易出错的地方。
    *   用代码（JSON/数据库）存储玩家卡（HP、属性、物品）。
    *   每次玩家发言时，把他的当前状态直接拼接到 Prompt 里告诉 AI。

---

### Alpha 版本实现步骤 (Roadmap)

建议技术栈：**Python** + **NoneBot2** (QQ机器人框架) + **OpenAI SDK** (调用大模型，可换 DeepSeek/Claude 等兼容接口)。

#### 第一阶段：基础设施搭建 (即使是 Alpha 版也必须稳)
1.  **环境配置**:
    *   创建 Python 虚拟环境。
    *   安装 `nonebot2[fastapi]` 和适配器 `nonebot-adapter-onebot`。
    *   配置 `.env` 文件（填入 LLM API Key，QQ 机器人连接配置）。
2.  **跑通 Hello World**:
    *   确保你的机器人能连接到 QQ (通常使用 LLOneBot 或 NapCat 等 NTQQ 协议端)。
    *   实现一个简单的 `echo` 指令，确保收发消息正常。

#### 第二阶段：核心“大脑”接入 (LLM)
1.  **封装 AI 接口**:
    *   编写一个 `utils/ai.py`，专门负责发送 Prompt 给 LLM 并获取回复。
2.  **设计 System Prompt (DM 人格)**:
    *   这是 Alpha 版的灵魂。
    *   *Prompt 示例*: "你是一个 DND 地下城主。请根据玩家的行动描述结果。如果是战斗，请描述战斗过程。请保持回复简短（200字以内）。"

#### 第三阶段：上下文与记忆系统 (关键！)
这是你最关心的部分，由代码逻辑控制：
1.  **会话管理器**:
    *   创建一个 `SessionManager` 类。
    *   用一个 `List` 存储群里的最近对话。
    *   当列表超过一定长度（如 20 条），删除最早的，保留最新的。
2.  **构建动态 Prompt**:
    *   在发送给 LLM 之前，组装最终文本：
    ```text
    System: 你是 DM...
    Context: (如果有剧情摘要，填在这里)
    Chat History:
    Player A: 我要攻击哥布林
    DM: 你挥剑...
    Player B: 我加血
    (当前玩家输入): Player A: 我再次攻击
    ```

#### 第四阶段：简单的数值系统 (这也是为了减轻 AI 记忆负担)
1.  **简易角色卡 (JSON)**:
    *   不用做复杂的 DND 5E 卡。只需：`名字`, `HP`, `职业`, `攻击力`。
    *   编写指令 `.st name 战士` 注册角色。
2.  **状态注入**:
    *   在上面的 Prompt 中，加入一段 `[当前场上信息]`:
    *   `Player A: HP 10/10, Player B: HP 5/10`。
    *   这样 AI 每次生成剧情时，都能看到最新的血量，不会胡说八道。

#### 第五阶段：骰子与判定 (规则的执行者)
1.  **代码骰子**:
    *   `.r 1d20` 指令由代码处理，算出结果 `15`。
    *   将结果喂给 AI：`System: 玩家 Player A 投掷了 1d20，结果是 15。根据这个结果描述他的行动成败。`
    *   **让 AI 解释结果，而不是让 AI 产生随机数。**

---
