# DND AI Dungeon Master Bot

这是一个基于 Go 语言开发的 DND (龙与地下城) 跑团辅助机器人，旨在通过接入大语言模型 (LLM)，如 DeepSeek/OpenAI，来扮演地下城主 (DM) 的角色，为玩家提供沉浸式的文字跑团体验。

本项目通过 OneBot V11 协议接入 QQ，借助 **Docker** 即可实现一键部署。

## ✨ 核心特性

*   **🧙 AI DM 主持**: 接入 DeepSeek-V3/R1 等模型，实时生成剧情，扮演 DM。
*   **🧠 智能记忆系统**: 
    *   **自动摘要**: 自动总结长剧情，保证 AI 记性好。
    *   **快照存档**: 支持 `.snapshot` 和 `.delsnapshot` 指令，随时保存/恢复游戏进度，重启不丢失。
*   **🎲 真实的骰子与检定**: 内置 `.r` 投骰指令，结果真实随机，AI 根据点数裁决。
*   **⚡ 自动化规则执行**: AI 可自动判定伤害并在数据库中扣除玩家生命值。
*   **📂 简易部署**: 通过 Docker Compose 配合 NapCat 快速搭建。

---

## 🚀 这里的教程是给纯小白看的：如何一步步部署

哪怕你没有任何编程基础，只要跟着下面的步骤做，也能把机器人跑起来。

### 第一步：准备工作（必须做！）

1.  **准备一个服务器或电脑**：
    *   可以是云服务器（腾讯云/阿里云等），也可以是你本地长期开机的电脑。
    *   系统推荐：Windows 或 Linux (Ubuntu/CentOS)。
2.  **安装 Docker**：
    *   这是运行机器人的基础。请去 [Docker 官网](https://www.docker.com/products/docker-desktop/) 下载并安装 **Docker Desktop**。
    *   安装完后，打开 Docker Desktop，确保它左下角显示绿色的运行状态。

### 第二步：下载代码与创建文件夹

1.  **下载本项目**：
    *   点击右上角的 `Code` -> `Download ZIP`，下载并解压到一个文件夹（比如 `DNDBot`）。
2.  **创建配置文件夹（重要！）**：
    *   打开解压后的 `DNDBot` 文件夹。
    *   在里面**手动新建一个文件夹**，命名为 `napcat`。
    *   进入 `napcat` 文件夹，再**新建一个文件夹**，命名为 `config`。
    *   *此时你的目录结构应该是这样的*：
        ```text
        DNDBot/
        ├── napcat/
        │   └── config/    <-- 空文件夹，等会儿程序会自动在这里生成文件
        ├── docker-compose.yml
        ├── .env
        ├── main.go
        └── ...其他文件
        ```

### 第三步：填写配置

1.  **修改 `.env` 文件**：
    *   在文件夹里找到 `.env` 文件（如果没有，就新建一个文本文件改名为 `.env`）。
    *   用记事本打开它，填入你的 **API Key** 和 **QQ 号**：

    ```env
    # ========================
    # AI 模型配置
    # ========================
    # 你的 DeepSeek API Key (去 deepseek 官网申请)
    OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx

    # 如果你是 DeepSeek，下面这两行不用改
    OPENAI_BASE_URL=https://api.deepseek.com
    MODEL_NAME=deepseek-chat

    # ========================
    # QQ 账号配置
    # ========================
    # 你的机器人 QQ 号（建议用小号）
    QQ_ACCOUNT=123456789
    
    # 网络配置（一般不用改）
    ONEBOT_WS_URL=ws://napcat:3001
    ```

### 第四步：启动机器人

1.  **打开终端**：
    *   在 `DNDBot` 文件夹的空白处，按住 `Shift` 键，点击**鼠标右键**，选择“**在此处打开 Powershell 窗口**”或者“**在终端中打开**”。
2.  **运行启动命令**：
    *   在弹出的黑框框里，复制并运行下面这行命令：
    ```bash
    docker-compose up -d
    ```
    *   *第一次运行会下载很多东西，可能需要等几分钟，请耐心等待。*

### 第五步：扫码登录 QQ

1.  **查看二维码**：
    *   等上面的命令跑完（不再动了），输入下面这行命令来查看登录二维码：
    ```bash
    docker logs -f napcat
    ```
2.  **扫码**：
    *   你会看到屏幕上出现一个二维码。用你的手机 QQ（就是上面填的那个账号）扫一扫登录。
    *   *注意：如果要在服务器登录，可能需要把二维码截图传到手机上扫，或者确保手机和服务器网络环境不冲突。*
3.  **退出日志查看**：
    *   扫码成功显示“登录成功”后，按 `Ctrl + C` 退出日志界面。

### 第六步：大功告成！

现在，在那个 QQ 号所在的群里，发送以下指令试试看：

*   `.st 勇者 战士 100 15` (创建一张卡：名字叫勇者，职业战士，HP100，力量15)
*   `.show 勇者` (查看角色卡)
*   `.snapshot` (存档)
*   或者直接说话，看看 AI DM 会不会理你！

---

## 🛠️ 常用指令表

| 指令 | 格式 | 说明 |
| :--- | :--- | :--- |
| **创建角色** | `.st [名字] [职业] [HP] [力量]` | 必须先创建角色才能玩，例如 `.st 派蒙 应急食品 10 5` |
| **查看状态** | `.show [名字]` | 查看某个角色的血量、职业等信息 |
| **投掷骰子** | `.r [公式]` | 例如 `.r 1d20` 或 `.r 2d6+3`，Bot 会播报结果并让 DM 判定 |
| **存档(快照)** | `.snapshot` | 保存当前所有进度（角色、剧情、背景）到服务器 |
| **删档** | `.delsnapshot` | 删除最新的那个存档 |
| **重置记忆** | `.reset` | 清空当前群的对话历史（慎用） |
| **检查连接** | `.check` | 检查 Bot 是否活着，以及 AI 连通性 |

## ❓ 常见问题

**Q: 只有 `napcat` 文件夹是空的吗？**
A: 是的，你需要自己新建 `napcat/config` 文件夹。第一次启动后，NapCat 会自动往里面生成一堆配置文件。

**Q: 重启电脑后还需要再操作一遍吗？**
A: 不需要！Docker 会自动在后台运行。如果它没跑，打开 Docker Desktop 即可。

**Q: 我想修改代码怎么办？**
A: 修改完代码后，运行 `docker-compose up -d --build` 重新构建并运行即可。
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.deepseek.com
MODEL_NAME=deepseek-chat

# ========================
# QQ 账号配置 (用于 NapCat 自动登录)
# ========================
QQ_ACCOUNT=123456789

# ========================
# 机器人连接配置
# ========================
# 如果使用 Docker Compose 部署，请保持为空或保持默认 (ws://napcat:3001)
# 宿主机网络或本地调试则填写: ws://127.0.0.1:3001
ONEBOT_WS_URL=ws://napcat:3001
# 如果 NapCat 配置了 Token，请在此填写，否则留空
ONEBOT_ACCESS_TOKEN=
```

### 3. 启动服务 (方式 A: Docker)

```bash
docker-compose up -d
```

### 3. 启动服务 (方式 B: Windows 本地运行 - 推荐)
如果 Docker 网络有问题，请直接在 Windows 上运行：

1.  **下载 NapCat**: 前往 [NapCat Release](https://github.com/NapNeko/NapCatQQ/releases) 下载最新 Windows 版本（如 `NapCat.Shell.zip`）。
2.  **运行 NapCat**: 
    * 解压并运行 `NapCat.Shell.exe`。
    * 输入你的 QQ 号，按提示**扫码登录**。
    * **重要配置**: 确保 NapCat 开启了 WebSocket 服务，端口为 **3001**。
      *(NapCat 默认 WebUI 地址为 http://127.0.0.1:6099/webui，进入网络配置页面，添加一个 WebSocket Server，端口设为 3001，Host设为 0.0.0.0，并在 DNDBot 的 .env 中确保 ONEBOT_WS_URL=ws://127.0.0.1:3001)*
3.  **启动机器人**:
    * 直接双击 `run_local.bat` (如果你想进 CLI 模式)。
    * 或者在终端运行 `go run main.go`。

### 4. 扫码登录 QQ (Docker 模式)

服务启动后，NapCat 容器需要你扫码登录 QQ。

1.  查看日志获取二维码：
    ```bash
    docker logs -f napcat
    ```
2.  终端屏幕上会显示一个二维码，**请使用手机 QQ 扫描该二维码** 并确认登录。
3.  看到 "登录成功" 或类似日志后，机器人即准备就绪。

### 5. 群聊使用方法

将你的机器人 QQ 拉入群聊，然后即可开始交互：

*   **@机器人 + 文字**: 与 DM 进行对话，推进剧情。
    *   *示例*: `@DNDBot 我向酒馆老板打听最近关于“失落矿坑”的传闻。`
*   **`.r [表达式]`**: 投掷骰子。
    *   *示例*: `.r 1d20`
    *   机器人会回复你的点数，并将其记录到 DM 的后台日志中，供下一次剧情裁决使用。
*   **DM 主动判定**:
    *   如果 DM 认为你需要进行检定（如感知、敏捷豁免），它会在回复中说明，并可能直接帮你投暗骰，或者要求你自己投。
    *   如果有战斗发生，Bot 会自动计算并在后台扣除你的 HP。

---

## 🛠️ 本地开发与 CLI 模式

如果你不需要连接 QQ，只想在终端里快速测试 AI 逻辑：

1.  确保 `.env` 中 **不要** 设置 `ONEBOT_WS_URL` (或将其留空)。
2.  运行程序：
    ```bash
    go run .
    ```
3.  你将进入命令行交互模式，可以直接输入对话。

### CLI 独有指令
*   `.st [name] [class] [hp] [str]`: 创建一张临时角色卡。
*   `.show`: 查看当前状态。
*   `.reset`: 重置记忆。

## ⚠️ 常见问题

**Q: Docker 拉取镜像一直失败？**
A: 这是通过由于国内网络环境导致 Docker Hub 访问受阻。请尝试配置国内镜像源（如阿里云、网易云），或者在本地开启代理。

**Q: 扫码后 NapCat 提示异地登录或风控？**
A: 新账号或长期未使用的账号容易触发风控。建议先在手机上挂几天，或者在同一网络环境下扫码。

**Q: 机器人没有回复群消息？**
A: 
1. 检查 Logs: `docker logs dndbot` 查看是否有报错。
2. 确认你是否 **@了机器人** (当前逻辑要求群聊必须 @ 才会触发回复)。
3. 检查 API Key 余额是否充足。
